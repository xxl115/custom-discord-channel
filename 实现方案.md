# OpenClaw 自定义 Discord Channel 实现方案

## 背景

OpenClaw 内置的 Discord Channel 使用 `@buape/carbon` 包，该包不支持代理配置，导致国内网络环境下 WebSocket 连接不稳定（频繁 1006 错误）。

## 解决方案

实现一个自定义的 Discord Channel Plugin，完全控制 WebSocket 连接和代理配置。

## 项目结构

```
custom-discord-channel/
├── index.ts                 # OpenClaw插件入口
├── openclaw.plugin.json     # 插件配置
├── package.json
├── tsconfig.json
└── src/
    ├── channel.ts           # Channel Plugin主逻辑
    ├── gateway.ts          # WebSocket Gateway（支持代理）
    ├── config.ts           # 配置Schema
    ├── api.ts              # Discord REST API
    └── types.ts            # TypeScript类型定义
```

## 核心优势

### 1. 完全控制 WebSocket 连接

```typescript
// src/gateway.ts
export class DiscordGateway {
  constructor(token: string, proxyUrl?: string) {
    // ✅ 可以自定义代理配置
    if (proxyUrl) {
      wsOptions.agent = new HttpsProxyAgent(proxyUrl);
    }
  }
}
```

### 2. 独立维护，不受上游影响

- 不依赖 `@buape/carbon` 包
- 更新 OpenClaw 不会覆盖修改
- 可以根据需要定制功能

### 3. 支持多种代理

- HTTP/HTTPS 代理
- SOCKS5 代理
- 环境变量配置
- 配置文件配置

## 部署步骤

### 方式一：链接到 OpenClaw

```bash
# 编译
cd custom-discord-channel
npm install
npm run build

# 创建链接
ln -sf $(pwd)/dist ~/.openclaw/extensions/custom-discord
```

### 方式二：复制到 extensions 目录

```bash
cp -r dist/* ~/.openclaw/extensions/custom-discord/
```

### 方式三：独立维护

```bash
# 在项目目录外维护
cd ~/projects/custom-discord-channel
npm run build

# 创建符号链接
ln -sf $(pwd)/dist ~/.openclaw/extensions/custom-discord
```

## 配置

### 环境变量

```bash
export DISCORD_BOT_TOKEN=your_token
export HTTP_PROXY=http://127.0.0.1:7890
export HTTPS_PROXY=http://127.0.0.1:7890
```

### OpenClaw 配置

```json
{
  "channels": {
    "discord-custom": {
      "enabled": true,
      "token": "YOUR_BOT_TOKEN",
      "proxy": {
        "enabled": true,
        "url": "http://127.0.0.1:7890"
      }
    }
  }
}
```

## 功能对比

| 功能 | 内置 @buape/carbon | 自定义实现 |
|------|-------------------|-----------|
| WebSocket Gateway | ✅ | ✅ |
| REST API | ✅ | ✅ |
| 代理支持 | ❌ | ✅ |
| Message Content Intent | ✅ | ✅ |
| 定时任务 | ✅ | ✅ |
| 实时响应 | ❌ (不稳定) | ✅ (稳定) |
| 维护成本 | 官方 | 自行 |

## 实施风险

1. **功能完整性** - 需要完整实现所有功能
2. **维护成本** - 需要跟踪 Discord API 变化
3. **兼容性** - 需要与 OpenClaw 版本兼容

## 建议

### 短期方案

使用 `patch-package` 修补 `@buape/carbon`，添加代理支持。

### 中期方案

实现自定义 Channel Plugin，逐步迁移功能。

### 长期方案

向 OpenClaw 提交 PR，在核心代码中支持代理配置。

## 参考资料

- [OpenClaw 插件开发](https://github.com/openclaw/openclaw)
- [Discord Gateway](https://discord.com/developers/docs/topics/gateway)
- [ws 库](https://github.com/websockets/ws)
- [proxy-agent](https://github.com/TooTallNate/proxy-agent)
